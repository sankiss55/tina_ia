<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOLO Detector en Vivo</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

  <style>
    body {
      margin: 0;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
      color: white;
    }

    #wrapper {
      position: relative;
      border: 4px solid #333;
      border-radius: 12px;
      overflow: hidden;
    }

    video {
      display: block;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none; /* ðŸ‘ˆ IMPORTANTE */
    }

    #status {
      margin-bottom: 12px;
      padding: 8px 16px;
      border-radius: 20px;
      background: #333;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <div id="status">INICIALIZANDO...</div>

  <div id="wrapper">
    <video id="video" width="640" height="480" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const status = document.getElementById("status");

    let model;
    const CONF_THRESHOLD = 0.5;

    let frameCount = 0;
    const DETECT_EVERY_N_FRAMES = 8;

    // ðŸ”¥ FORZAR GPU
    async function forceBackend() {
      await tf.setBackend("webgl");
      await tf.ready();

      const backend = tf.getBackend();
      alert(
        backend === "webgl"
          ? "âœ… Usando GPU (WebGL)"
          : "âŒ Usando CPU"
      );

      status.textContent = `Backend: ${backend.toUpperCase()}`;
      status.style.background = backend === "webgl" ? "#006600" : "#660000";
    }

    // ðŸ“· CÃMARA
    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480, facingMode: "environment" }
      });
      video.srcObject = stream;
      return new Promise(r => video.onloadedmetadata = r);
    }

    // ðŸ§  MODELO
    async function loadYOLO() {
      status.textContent = "CARGANDO MODELO...";
      model = await tf.loadGraphModel("./model/model.json");
      status.textContent = "MODELO LISTO";
      status.style.background = "#333";
    }

    // ðŸ” LOOP
    async function loop() {
      frameCount++;

      // Canvas siempre del tamaÃ±o del video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Limpia SOLO las cajas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (frameCount % DETECT_EVERY_N_FRAMES === 0) {
        await detect();
      }

      requestAnimationFrame(loop);
    }

    // ðŸŽ¯ DETECCIÃ“N
    async function detect() {
      if (!model) return;

      const input = tf.tidy(() =>
        tf.browser.fromPixels(video)
          .resizeBilinear([640, 640])
          .div(255)
          .expandDims(0)
      );

      let output = model.execute(input);
      let raw;

      if (output instanceof tf.Tensor) raw = output;
      else if (Array.isArray(output)) raw = output[0];
      else raw = output[Object.keys(output)[0]];

      if (raw.shape[1] < raw.shape[2]) {
        raw = raw.transpose([0, 2, 1]);
      }

      const data = await raw.array();
      const predictions = data[0];

      let found = false;

      predictions.forEach(row => {
        const scores = row.slice(4);
        const maxScore = Math.max(...scores);

        if (maxScore > CONF_THRESHOLD) {
          found = true;

          const [cx, cy, w, h] = row.slice(0, 4);
          const scaleX = canvas.width / 640;
          const scaleY = canvas.height / 640;

          const width = w * scaleX;
          const height = h * scaleY;
          const x = cx * scaleX - width / 2;
          const y = cy * scaleY - height / 2;

          ctx.strokeStyle = "#00FF00";
          ctx.lineWidth = 3;
          ctx.strokeRect(x, y, width, height);

          ctx.fillStyle = "#00FF00";
          ctx.font = "16px Arial";
          const label = `${(maxScore * 100).toFixed(0)}%`;
          ctx.fillRect(x, y - 22, ctx.measureText(label).width + 10, 22);
          ctx.fillStyle = "#000";
          ctx.fillText(label, x + 5, y - 6);
        }
      });

      status.textContent = found
        ? "OBJETO DETECTADO"
        : "BUSCANDO...";

      tf.dispose([input, output, raw]);
    }

    async function main() {
      await forceBackend();
      await setupCamera();
      await loadYOLO();
      loop();
    }

    main();
  </script>

</body>
</html>
